{% extends "base.html" %}

{% block title %}Now Playing{% endblock %}

{% block content %}
<!-- 參考網址 https://codepen.io/Nirtz89/pen/abzyjYz -->
<link rel="stylesheet" type="text/css" href="/static/css/style.css">
<div class="container">
  <div class="iphone neu">
    <div class="title">
      <div><i class="fas fa-chevron-left"></i></div>
      <div>NOW PLAYING</div>
      <div id="playlist-button"><i class="fas fa-ellipsis-v"></i></div>
    </div>

    <div class="album-cover">
      <div class="album-overlay"></div>
      <img id="album-cover"
        alt="rock">
      <div class="album-text">
        <h2 id="song-title">
          Song Name
        </h2>
        <h3 id="artist-title">
          Artist Name
        </h3>
      </div>
    </div>

    <div class="buttons">
      <button class="btn lg red neu" id="fav-button"><i class="fas fa-heart"></i></button>
      <button class="btn lg neu" id="prev-button"><i class="fas fa-backward"></i></button>
      <button class="btn lg neu" id="play-button"><i class="fas fa-play"></i></button>
      <button class="btn lg neu" id="next-button"><i class="fas fa-forward"></i></button>
    </div>

    <audio id="audio-player"></audio>

    <div style="padding-top: 1em;"></div>

    <div class="track-container">
      <div class="track neu" id="progress-container">
        <div id="progress"></div>
      </div>

      <div class="progress-time-display">
        <div id="now-display" class="time-display">0:00</div>
        <div id="total-display" class="time-display">0:00</div>
      </div>
    </div>

    <div style="padding-top: 1em;"></div>
    <div class="sound-container">
      <div class="volume-icon">
        <i class="fas fa-volume-up sound-icon"></i>
        <div id="sound-display" class="time-display">100%</div>
      </div>
      <div class="track neu" id="soundbar-container">
        <div id="sound-bar"></div>
      </div>
    </div>
    <!-- <div class="lyrics">
        <i class="fas fa-angle-up"></i>
        <span>LYRICS</span>
      </div> -->
  </div>

  <div class="neu playlist song-list">
    <div class="title">
      <div>PLAY LIST</div>
    </div>
    <!-- <div class="song-list"> -->
      {% for song in playlist_data %}
      <button class="song neu-s" data-count="{{ loop.index0 }}">
        <img src="{{ song.thumbnail_url }}" alt="{{ song.title }}">
        <div class="song-text">
          <h2 class="song-title">
            {{ song.title }}
          </h2>
          <h3 class="artist-title">
            {{ song.artist }}
          </h3>
        </div>
      </button>
      {% endfor %}
    <!-- </div> -->
  </div>
</div>

<script>
  // 目前進度整理
  // 暫停、播放沒問題
  // 下一首、上一首沒問題
  // 循環播放、隨機播放等等還沒處理
  // 目前會自動播放下一首
  // 預設循環播放狀態
  // TODO: show all song in playlist
  // TODO: add song
  $(document).ready(function () {

    let playlist = {{ playlist_data | tojson }};
    let currentIndex = 0;
    let isPlaying = false;

    // 音量控制

    const $soundbarContainer = $("#soundbar-container");
    const $soundbar = $("#sound-bar");
    const $soundDisplay = $("#sound-display");

    $soundbarContainer.on("click", (e) => {
      const width = $soundbarContainer.width();
      const clickX = e.offsetX * 1.05;
      const volume = Math.min(clickX / width, 1);
      $soundbar.css("width", `${ volume * 100 }%`);
      audio.volume = volume;
      $soundDisplay.text(`${ Math.round(volume * 100) }%`);
    });

    // 進度條控制

    const $progressContainer = $("#progress-container");
    const $progress = $("#progress");

    $progressContainer.on("click", (e) => {
      const width = $progressContainer.width();
      const clickX = e.offsetX;
      const duration = audio.duration;
      audio.currentTime = (clickX / width) * duration;
    });

    // 播放清單管理

    const $playlist = $(".playlist");

    function playlistVisibility() {
      if($playlist.css("display") === "none") {
        $playlist.css("display", "flex");
      } else {
        $playlist.css("display", "none");
      }
    } 

    $("#playlist-button").on("click", playlistVisibility);

    // 音樂播放器
    
    const $audioPlayer = $("#audio-player");
    const audio = $audioPlayer[0];

    function loadSong(index) {
      $("#song-title").text(playlist[index].title);
      $("#artist-title").text(playlist[index].artist);
      $("#album-cover").attr("src", playlist[index].thumbnail_url);
      $audioPlayer.attr("src", playlist[index].audio_url);
      if (isPlaying) {
        audio.play();
      }
    }

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    $audioPlayer.on("durationchange", () => {
      $("#total-display").text(formatTime(audio.duration));
    });

    $audioPlayer.on("timeupdate", () => {
      const currentTime = audio.currentTime;
      const duration = audio.duration;
      $progress.css("width", `${(currentTime / duration) * 100}%`);
      $("#now-display").text(formatTime(currentTime));
    });

    $audioPlayer.on("ended", function () {
      currentIndex = (currentIndex + 1) % playlist.length;
      loadSong(currentIndex);
    });

    // 按鈕處理

    $("#next-button").on("click", function () {
      currentIndex = (currentIndex + 1) % playlist.length;
      loadSong(currentIndex);
    });

    $("#prev-button").on("click", function () {
      currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
      loadSong(currentIndex);
    });

    $(".song").on("click", function () {
      const index = $(this).data("count");
      currentIndex = index;
      isPlaying = true;
      loadSong(index);
    });

    // 播放暫停按鈕

    const $playButton = $("#play-button");

    $playButton.on("click", () => {
      if (isPlaying) {
        audio.pause();
        $playButton.html('<i class="fas fa-play"></i>');
      } else {
        audio.play();
        $playButton.html('<i class="fas fa-pause"></i>');
      }
      isPlaying = !isPlaying;
    });

    // Initialize with the first song
    if (playlist.length > 0) {
      loadSong(0);
    }
  });
</script>

{% endblock %}